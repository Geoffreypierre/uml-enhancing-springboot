<?xml version="1.0" encoding="UTF-8"?>
<html>
  <head>
    <meta charset="UTF-8"/>
    <link rel="icon" type="image/x-icon" href="/ico.ico"/>
    <title>The UML enhancing project</title>
  </head>
  <body>
    <div class="scrolling-background"></div>
    <div class="scrolling"></div>
    <h1 class="title">Uml enhancing</h1>
    <div class="input-container">
      <form class="upload-form" method="post" enctype="multipart/form-data" action="/api/uml/upload">
        <div class="select-file">Choisissez un fichier PlantUML</div>
        <label class="file-label">
          <span class="file-button">Sélectionner un fichier</span>
          <input type="file" name="file" class="file-input" accept=".puml"/>
        </label>
        <div class="file-name" id="file-name">Aucun fichier sélectionné</div>
        <label class="float-label">
          <span>Seuil de pertinence (0 à 1)</span>
          <input type="number" id="relevanceValue" name="relevance" step="0.01" min="0" max="1" class="float-input" placeholder="0.75" value="0.75" required=""/>
        </label>
        <button type="submit" class="submit-button" disabled="">Traiter</button>
      </form>
    </div>
    <div class="img-container">
      <div class="img-container-title">UML en entrée</div>
      <img id="uml-image" class="before-uml"/>
      <div class="img-container-title">UML en sortie</div>
      <img id="uml-image-after" class="after-uml"/>
      <button id="download-button" class="download-button" style="display: none;">
            Télécharger le fichier .puml
        </button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script>
//<![CDATA[

        const button = document.querySelector('.submit-button');
        const fileInput = document.querySelector('.file-input');
        const fileName = document.getElementById('file-name');
        const umlImage = document.getElementById('uml-image');
        const form = document.querySelector('.upload-form');
        const umlImageAfter = document.getElementById('uml-image-after');
        const downloadButton = document.getElementById('download-button');

        let enhancedPumlContent = '';

        function encode64(data) {
            const r = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
            let s = "";

            for (let i = 0; i < data.length; i += 3) {
                if (i + 2 === data.length) {
                    s += append3bytes(data[i], data[i + 1], 0);
                } else if (i + 1 === data.length) {
                    s += append3bytes(data[i], 0, 0);
                } else {
                    s += append3bytes(data[i], data[i + 1], data[i + 2]);
                }
            }
            return s;
        }

        function append3bytes(b1, b2, b3) {
            const r = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
            const c1 = b1 >> 2;
            const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
            const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
            const c4 = b3 & 0x3F;
            return r.charAt(c1) + r.charAt(c2) + r.charAt(c3) + r.charAt(c4);
        }

        function compressAndEncode(text) {
            const data = unescape(encodeURIComponent(text));
            const compressed = pako.deflateRaw(data, { to: 'string' });
            return encode64(compressed);
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const file = fileInput.files[0];
            if (!file) return;

            const relevance = document.getElementById("relevanceValue").value;

            const formData = new FormData();
            formData.append("file", file);
            formData.append("relevance", relevance);

            try {
                const response = await fetch("/api/uml/upload", {
                    method: "POST",
                    body: formData
                });

                const enhancedPuml = await response.text();
                console.log("Enhanced PlantUML received:", enhancedPuml);

                if (!enhancedPuml || enhancedPuml.trim() === "") {
                    throw new Error("Empty response received from server");
                }

                // Store the enhanced PUML content for download
                enhancedPumlContent = enhancedPuml;

                // Render the enhanced PlantUML using the online PlantUML service
                try {
                    const encoded = compressAndEncode(enhancedPuml);
                    const imageUrl = "https://www.plantuml.com/plantuml/png/" + encoded;

                    umlImageAfter.onload = function () {
                        console.log("Image loaded successfully");
                        downloadButton.style.display = "block";
                    };

                    umlImageAfter.onerror = function () {
                        console.error("Failed to load rendered image");
                        alert("Erreur: Impossible de charger l'image rendue.");
                    };

                    umlImageAfter.src = imageUrl;
                    umlImageAfter.style.display = "block";
                } catch (error) {
                    console.error("Error encoding enhanced PlantUML:", error);
                    alert("Erreur lors du rendu de l'image: " + error.message);
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Erreur lors du traitement: " + error.message);
            }
        });

        fileInput.addEventListener('change', function () {
            if (this.files.length > 0) {
                button.disabled = false;

                fileName.textContent = this.files[0].name;
                fileName.classList.add("has-file");

                const reader = new FileReader();

                reader.onload = function (e) {
                    const pumlText = e.target.result;

                    try {
                        const encoded = compressAndEncode(pumlText);
                        const imageUrl = "https://www.plantuml.com/plantuml/png/" + encoded;

                        umlImage.src = imageUrl;
                        umlImage.style.display = "block";
                    } catch (error) {
                        console.error("Error encoding:", error);
                    }
                };

                reader.readAsText(this.files[0]);

            } else {
                button.disabled = true;
                fileName.textContent = "Aucun fichier sélectionné";
                fileName.classList.remove("has-file");
                umlImage.style.display = "none";
            }
        });

        downloadButton.addEventListener('click', function () {
            if (!enhancedPumlContent) {
                alert("Aucun contenu à télécharger");
                return;
            }

            const blob = new Blob([enhancedPumlContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'enhanced-diagram.puml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });
    
//]]>
    </script>
  </body>
</html>