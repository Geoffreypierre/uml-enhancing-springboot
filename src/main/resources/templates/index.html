<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/ico.ico">
    <title>The UML enhancing project</title>
</head>

<body>
<div class="scrolling-background"></div>
<div class="scrolling"></div>

<h1 class="title">Uml enhancing</h1>

<div class="input-container">
    <form class="upload-form"
          method="post"
          enctype="multipart/form-data"
          action="/api/uml/upload">

        <div class="select-file">Choisissez un fichier PlantUML</div>

        <label class="file-label">
            <span class="file-button">Sélectionner un fichier</span>
            <input type="file" name="file" class="file-input" accept=".puml">
        </label>

        <div class="file-name" id="file-name">Aucun fichier sélectionné</div>

        <label class="float-label">
            <span>Seuil de pertinence (0 à 1)</span>
            <input type="number"
                   id="relevanceValue"
                   name="relevance"
                   step="0.01"
                   min="0"
                   max="1"
                   class="float-input"
                   placeholder="0.75"
                   value="0.75"
                   required>
        </label>

        <button type="submit" class="submit-button" disabled>Traiter</button>
    </form>
</div>


<div class="img-container">
    <div class="img-container-title">UML en entrée</div>
    <img id="uml-image" class="before-uml">

    <div class="img-container-title">UML en sortie</div>
    <img id="uml-image-after" class="after-uml">
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

<script>
    const button = document.querySelector('.submit-button');
    const fileInput = document.querySelector('.file-input');
    const fileName = document.getElementById('file-name');
    const umlImage = document.getElementById('uml-image');
    const form = document.querySelector('.upload-form');
    const umlImageAfter = document.getElementById('uml-image-after');

    function encode64(data) {
        const r = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
        let s = "";

        for (let i = 0; i < data.length; i += 3) {
            if (i + 2 === data.length) {
                s += append3bytes(data[i], data[i + 1], 0);
            } else if (i + 1 === data.length) {
                s += append3bytes(data[i], 0, 0);
            } else {
                s += append3bytes(data[i], data[i + 1], data[i + 2]);
            }
        }
        return s;
    }

    function append3bytes(b1, b2, b3) {
        const r = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
        const c1 = b1 >> 2;
        const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
        const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
        const c4 = b3 & 0x3F;
        return r.charAt(c1) + r.charAt(c2) + r.charAt(c3) + r.charAt(c4);
    }

    function compressAndEncode(text) {
        const data = unescape(encodeURIComponent(text));
        const compressed = pako.deflateRaw(data, { to: 'string' });
        return encode64(compressed);
    }

    form.addEventListener('submit', async function (e) {
        e.preventDefault();

        const file = fileInput.files[0];
        if (!file) return;

        const relevance = document.getElementById("relevanceValue").value;

        const formData = new FormData();
        formData.append("file", file);
        formData.append("relevance", relevance);

        try {
            const response = await fetch("/api/uml/upload", {
                method: "POST",
                body: formData
            });

            const enhancedPuml = await response.text();
            console.log("Enhanced PlantUML received:", enhancedPuml);

            if (!enhancedPuml || enhancedPuml.trim() === "") {
                throw new Error("Empty response received from server");
            }

            // Render the enhanced PlantUML using the online PlantUML service
            try {
                const encoded = compressAndEncode(enhancedPuml);
                const imageUrl = "https://www.plantuml.com/plantuml/png/" + encoded;

                umlImageAfter.onload = function() {
                    console.log("Image loaded successfully");
                };

                umlImageAfter.onerror = function() {
                    console.error("Failed to load rendered image");
                    alert("Erreur: Impossible de charger l'image rendue.");
                };

                umlImageAfter.src = imageUrl;
                umlImageAfter.style.display = "block";
            } catch (error) {
                console.error("Error encoding enhanced PlantUML:", error);
                alert("Erreur lors du rendu de l'image: " + error.message);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Erreur lors du traitement: " + error.message);
        }
    });

    fileInput.addEventListener('change', function () {
        if (this.files.length > 0) {
            button.disabled = false;

            fileName.textContent = this.files[0].name;
            fileName.classList.add("has-file");

            const reader = new FileReader();

            reader.onload = function (e) {
                const pumlText = e.target.result;

                try {
                    const encoded = compressAndEncode(pumlText);
                    const imageUrl = "https://www.plantuml.com/plantuml/png/" + encoded;

                    umlImage.src = imageUrl;
                    umlImage.style.display = "block";
                } catch (error) {
                    console.error("Error encoding:", error);
                }
            };

            reader.readAsText(this.files[0]);

        } else {
            button.disabled = true;
            fileName.textContent = "Aucun fichier sélectionné";
            fileName.classList.remove("has-file");
            umlImage.style.display = "none";
        }
    });
</script>

</body>


<style>
    body {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        margin: 0;
        padding: 20px;
        opacity: 0.9;
        font-family: monospace;
        overflow: auto;
        background-color: #4d38ff;
    }

    .scrolling-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('/bg.png');
        background-size: 350px 300px;
        background-repeat: repeat;
        background-position: top left;
        animation: moveBackground 100s linear infinite;
        z-index: -1;
    }

    .scrolling {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #44D7FF, #0057FF);
        z-index: -2;
    }

    @keyframes moveBackground {
        from { background-position: 0 0; }
        to   { background-position: -500px -500px; }
    }

    .title {
        margin: 20px auto;
        text-align: center;
        padding: 15px 25px;
        background-color: white;
        border: solid 4px black;
        width: 275px;
        border-radius: 5px;
        font-size: 32px;
        box-shadow: 5px 5px 0 black;
    }

    .input-container {
        border: solid 4px black;
        background-color: white;
        border-radius: 8px;
        padding: 25px 15px;
        text-align: center;
        width: 450px;
        margin: 50px auto 30px auto;
        font-size: 18px;
    }

    .select-file {
        font-size: 22px;
        margin-bottom: 40px;
        font-weight: bold;
    }

    .file-label {
        display: inline-block;
        cursor: pointer;
    }

    .file-button {
        background-color: #ffffff;
        border: solid 3px black;
        padding: 12px 25px;
        font-size: 18px;
        border-radius: 6px;
        box-shadow: 4px 4px 0 black;
        transition: transform 0.1s ease;
        display: inline-block;
    }

    .file-button:hover {
        transform: translate(-2px, -2px);
    }

    .file-input {
        display: none;
    }

    .file-name {
        font-size: 16px;
        font-style: italic;
        color: #222;
        width: fit-content;
        margin: 20px auto;
        padding: 10px;
    }

    .file-name.has-file {
        background-color: #a1c1ff;
        border-radius: 15px;
        box-shadow: 3px 3px 0 #7daaff;
        color: white;
    }

    .submit-button {
        margin-top: 20px;
        background-color: #000000;
        padding: 5px 15px;
        font-size: 18px;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        transition: transform 0.1s ease;
        font-family: monospace;
    }

    .submit-button:hover {
        transform: translate(-2px, -2px);
    }

    .submit-button:disabled {
        background-color: gray;
        cursor: not-allowed;
        transform: none;
        color: #ccc;
    }

    .submit-button:disabled:hover {
        transform: none;
    }

    .before-uml {
        display:none;
        margin-top:25px;
        max-width:100%;
        border:3px solid black;
        border-radius:8px;
    }

    .after-uml {
        display:none;
        margin-top:25px;
        max-width:100%;
        border:3px solid black;
        border-radius:8px;
    }

    .img-container {
        text-align: center;
        width: 90%;
        margin: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
    }

    .img-container-title {
        padding: 5px 15px;
        background-color: white;
        border: solid 3px black;
        font-size: 20px;
        border-radius: 5px;
        margin: 20px auto;
        font-weight: bold;
    }

    .float-input {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        font-size: 16px;
        border: 2px solid black;
        border-radius: 5px;
        font-family: monospace;
    }

    .float-label {
        display: block;
        margin-top: 20px;
        font-weight: bold;
    }

</style>

</html>